# LockFree Price Engine

> åŸºäºLMAX Disruptorçš„æ— é”é«˜é¢‘äº¤æ˜“ä»·æ ¼å¼•æ“å®ç°

## é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„æ— é”ä»·æ ¼å¤„ç†å¼•æ“ï¼Œä¸“ä¸ºé«˜é¢‘äº¤æ˜“(HFT)åœºæ™¯è®¾è®¡ã€‚é€šè¿‡LMAX Disruptoræ¡†æ¶å®ç°å®Œå…¨æ— é”çš„å¹¶å‘æ¶æ„ï¼Œèƒ½å¤Ÿå¤„ç†æ¯ç§’ç™¾ä¸‡çº§çš„ä»·æ ¼æ›´æ–°ï¼Œå»¶è¿Ÿæ§åˆ¶åœ¨10å¾®ç§’ä»¥å†…ã€‚

### æ ¸å¿ƒç‰¹æ€§

- **ğŸš€ æè‡´æ€§èƒ½**: æ”¯æŒ>100ä¸‡TPSï¼Œç«¯åˆ°ç«¯å»¶è¿Ÿ<10Î¼s
- **ğŸ”’ å®Œå…¨æ— é”**: åŸºäºCASå’ŒRingBufferçš„æ— é”æ¶æ„  
- **ğŸ“Š é«˜ç²¾åº¦ç›‘æ§**: é›†æˆHdrHistogramè¿›è¡Œçº³ç§’çº§å»¶è¿Ÿç»Ÿè®¡
- **âš¡ CPUäº²å’Œæ€§**: æ”¯æŒçº¿ç¨‹ç»‘å®šï¼Œå‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢
- **ğŸ”§ çµæ´»é…ç½®**: å¤šç§ç­‰å¾…ç­–ç•¥å’Œç¼“å†²åŒºå¤§å°é…ç½®

### æŠ€æœ¯æ ˆ

- **Java 21**: æœ€æ–°LTSç‰ˆæœ¬ï¼Œæ”¯æŒè™šæ‹Ÿçº¿ç¨‹å’Œæ¨¡å¼åŒ¹é…
- **LMAX Disruptor 3.4.4**: é«˜æ€§èƒ½æ— é”ç¯å½¢é˜Ÿåˆ—
- **HdrHistogram 2.1.12**: é«˜ç²¾åº¦å»¶è¿Ÿç»Ÿè®¡
- **Thread Affinity 3.23.1**: CPUäº²å’Œæ€§æ§åˆ¶
- **JMH 1.37**: æ€§èƒ½åŸºå‡†æµ‹è¯•æ¡†æ¶
- **Gradle 8.4**: æ„å»ºå·¥å…·

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Java 21+
- Gradle 8.0+
- å†…å­˜: å»ºè®®4GB+

### æ„å»ºå’Œè¿è¡Œ

```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>
cd lock-free-price-engine

# ç¼–è¯‘é¡¹ç›®
./gradlew clean build

# è¿è¡Œæ¼”ç¤ºç¨‹åº
./gradlew run

# è¿è¡Œå•å…ƒæµ‹è¯•
./gradlew test

# è¿è¡Œå¿«é€ŸåŸºå‡†æµ‹è¯•
./gradlew quickBenchmark

# è¿è¡Œå®Œæ•´åŸºå‡†æµ‹è¯•
./gradlew jmh
```

## æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
æ•°æ®è¾“å…¥å±‚      æ— é”é€šä¿¡å±‚        äº‹ä»¶å¤„ç†é“¾         ç›‘æ§å±‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ä»·æ ¼ç”Ÿäº§è€…â”‚â”€â”€â”€â–¶â”‚ Disruptor â”‚â”€â”€â”€â–¶â”‚éªŒè¯â”‚èšåˆâ”‚åˆ†å‘â”‚â”€â”€â”€â–¶â”‚å»¶è¿Ÿç›‘æ§â”‚
â”‚ Threads â”‚    â”‚RingBufferâ”‚    â”‚Handler Chainâ”‚    â”‚ç»Ÿè®¡åˆ†æâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

1. **PriceEvent**: ä»·æ ¼äº‹ä»¶å¯¹è±¡ï¼Œåœ¨RingBufferä¸­å¾ªç¯ä½¿ç”¨
2. **ValidationHandler**: ä»·æ ¼æ•°æ®éªŒè¯å¤„ç†å™¨
3. **AggregationHandler**: ä»·æ ¼èšåˆå’Œè®¡ç®—å¤„ç†å™¨  
4. **DistributionHandler**: ä»·æ ¼åˆ†å‘å¤„ç†å™¨
5. **LockFreePriceEngine**: ä¸»å¼•æ“ï¼Œåè°ƒæ‰€æœ‰ç»„ä»¶

### å¤„ç†æµç¨‹

```mermaid
sequenceDiagram
    participant Producer
    participant RingBuffer
    participant Validation
    participant Aggregation  
    participant Distribution
    
    Producer->>RingBuffer: publishPrice()
    RingBuffer->>Validation: onEvent()
    Validation->>Aggregation: éªŒè¯é€šè¿‡
    Aggregation->>Distribution: è®¡ç®—å®Œæˆ
    Distribution->>Producer: å¼‚æ­¥é€šçŸ¥
```

## æ€§èƒ½åŸºå‡†æµ‹è¯•

### å¿«é€Ÿæµ‹è¯•
```bash
./gradlew quickBenchmark
```

### å»¶è¿Ÿæµ‹è¯•
```bash
./gradlew latencyBenchmark
```

### ååé‡æµ‹è¯•
```bash
./gradlew throughputBenchmark
```

### æµ‹è¯•ç»“æœç¤ºä¾‹

| æµ‹è¯•é¡¹ç›® | å»¶è¿Ÿ(ns) | ååé‡(ops/sec) | å¤‡æ³¨ |
|---------|----------|----------------|------|
| å•æ¬¡å‘å¸ƒ | ~50 | 20M+ | å•çº¿ç¨‹ |
| æ‰¹é‡å‘å¸ƒ | ~30 | 30M+ | 10ä¸ªä¸€æ‰¹ |
| ä»·æ ¼æŸ¥è¯¢ | ~10 | 100M+ | æ— é”è¯»å– |

## ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ä½¿ç”¨

```java
// åˆ›å»ºå¼•æ“
LockFreePriceEngine engine = new LockFreePriceEngine();

// å¯åŠ¨å¼•æ“
engine.start();

// å‘å¸ƒä»·æ ¼
boolean success = engine.publishPrice("EURUSD", 1.0999, 1.1001);

// æŸ¥è¯¢ä»·æ ¼
var price = engine.getAggregationHandler().getLatestPrice("EURUSD");
System.out.println("Latest EURUSD: " + price);

// å…³é—­å¼•æ“
engine.shutdown();
```

### è‡ªå®šä¹‰é…ç½®

```java
// è‡ªå®šä¹‰RingBufferå¤§å°å’Œç­‰å¾…ç­–ç•¥
WaitStrategy waitStrategy = new YieldingWaitStrategy();
LockFreePriceEngine engine = new LockFreePriceEngine(65536, waitStrategy);
```

### æ€§èƒ½ç›‘æ§

```java
// è·å–ç»Ÿè®¡ä¿¡æ¯
String stats = engine.getStatistics();
System.out.println(stats);

// è·å–RingBufferçŠ¶æ€
String bufferStatus = engine.getRingBufferStatus();
System.out.println(bufferStatus);
```

## é…ç½®é€‰é¡¹

### ç­‰å¾…ç­–ç•¥å¯¹æ¯”

| ç­–ç•¥ | å»¶è¿Ÿ | CPUä½¿ç”¨ | é€‚ç”¨åœºæ™¯ |
|------|------|---------|----------|
| BusySpinWaitStrategy | æœ€ä½ | æœ€é«˜ | è¶…ä½å»¶è¿Ÿè¦æ±‚ |
| YieldingWaitStrategy | ä½ | é«˜ | å¹³è¡¡æ€§èƒ½åœºæ™¯ |
| SleepingWaitStrategy | ä¸­ç­‰ | ä½ | èŠ‚èƒ½åœºæ™¯ |
| BlockingWaitStrategy | é«˜ | æœ€ä½ | ä½é¢‘åœºæ™¯ |

### RingBufferå¤§å°å»ºè®®

- **16K**: é€‚åˆä½å»¶è¿Ÿè¦æ±‚ï¼Œå†…å­˜å‹å¥½
- **64K**: å¹³è¡¡é€‰æ‹©ï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯  
- **256K**: é«˜ååé‡åœºæ™¯ï¼Œéœ€è¦æ›´å¤šå†…å­˜

## æ€§èƒ½è°ƒä¼˜

### JVMå‚æ•°å»ºè®®

```bash
-Xms2g -Xmx2g                          # å›ºå®šå †å¤§å°
-XX:+UseZGC                             # ä½¿ç”¨ZGCä½å»¶è¿Ÿåƒåœ¾æ”¶é›†å™¨
-XX:MaxGCPauseMillis=1                  # æœ€å¤§GCåœé¡¿1ms
-XX:+UnlockExperimentalVMOptions        # å¯ç”¨å®éªŒæ€§åŠŸèƒ½
--add-exports java.base/sun.misc=ALL-UNNAMED  # å…è®¸è®¿é—®å†…éƒ¨API
```

### ç³»ç»Ÿçº§ä¼˜åŒ–

1. **CPUäº²å’Œæ€§**: ç»‘å®šå…³é”®çº¿ç¨‹åˆ°ç‰¹å®šCPUæ ¸å¿ƒ
2. **NUMAä¼˜åŒ–**: ä¼˜åŒ–å†…å­˜è®¿é—®å±€éƒ¨æ€§
3. **ç½‘ç»œä¸­æ–­**: è°ƒæ•´ç½‘ç»œä¸­æ–­å¤„ç†
4. **å†…æ ¸å‚æ•°**: ä¼˜åŒ–å†…æ ¸è°ƒåº¦å‚æ•°

## ç›‘æ§æŒ‡æ ‡

### æ ¸å¿ƒKPI

- **å»¶è¿ŸæŒ‡æ ‡**: P50, P95, P99, P99.9å»¶è¿Ÿåˆ†å¸ƒ
- **ååé‡**: æ¯ç§’å¤„ç†çš„ä»·æ ¼æ›´æ–°æ•°é‡
- **é”™è¯¯ç‡**: éªŒè¯å¤±è´¥å’Œå¤„ç†å¼‚å¸¸æ¯”ä¾‹
- **èµ„æºä½¿ç”¨**: CPUä½¿ç”¨ç‡å’Œå†…å­˜å ç”¨

### ç›‘æ§å·¥å…·

- **HdrHistogram**: é«˜ç²¾åº¦å»¶è¿Ÿç»Ÿè®¡
- **JVMæŒ‡æ ‡**: GCåœé¡¿æ—¶é—´å’Œé¢‘ç‡
- **ç³»ç»ŸæŒ‡æ ‡**: CPUã€å†…å­˜ã€ç½‘ç»œä½¿ç”¨æƒ…å†µ

## æµ‹è¯•è¦†ç›–

### å•å…ƒæµ‹è¯•
- äº‹ä»¶å¯¹è±¡æµ‹è¯•
- å¤„ç†å™¨åŠŸèƒ½æµ‹è¯•
- å¼•æ“ç”Ÿå‘½å‘¨æœŸæµ‹è¯•

### é›†æˆæµ‹è¯•  
- ç«¯åˆ°ç«¯å¤„ç†æµç¨‹
- å¹¶å‘å®‰å…¨æ€§éªŒè¯
- å¼‚å¸¸å¤„ç†æµ‹è¯•

### æ€§èƒ½æµ‹è¯•
- å»¶è¿ŸåŸºå‡†æµ‹è¯•
- ååé‡å‹åŠ›æµ‹è¯•
- é•¿æœŸç¨³å®šæ€§æµ‹è¯•

## é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ main/java/com/hft/lockfree/
â”‚   â”œâ”€â”€ engine/          # æ ¸å¿ƒå¼•æ“
â”‚   â”œâ”€â”€ event/           # äº‹ä»¶å®šä¹‰
â”‚   â”œâ”€â”€ handler/         # äº‹ä»¶å¤„ç†å™¨
â”‚   â”œâ”€â”€ monitor/         # ç›‘æ§ç»„ä»¶
â”‚   â””â”€â”€ util/            # å·¥å…·ç±»
â”œâ”€â”€ test/java/           # å•å…ƒæµ‹è¯•
â””â”€â”€ jmh/java/            # JMHåŸºå‡†æµ‹è¯•
```

## æ‰©å±•å¼€å‘

### æ·»åŠ æ–°çš„å¤„ç†å™¨

1. å®ç°`PriceEventHandler`æ¥å£
2. åœ¨å¼•æ“ä¸­æ³¨å†Œå¤„ç†å™¨
3. é…ç½®å¤„ç†é“¾é¡ºåº

### è‡ªå®šä¹‰ç­‰å¾…ç­–ç•¥

1. ç»§æ‰¿Disruptorç­‰å¾…ç­–ç•¥
2. å®ç°æ€§èƒ½ä¼˜åŒ–é€»è¾‘
3. åœ¨å¼•æ“é…ç½®ä¸­ä½¿ç”¨

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **å†…å­˜ä¸è¶³**: å¢åŠ å †å†…å­˜æˆ–å‡å°‘RingBufferå¤§å°
2. **GCåœé¡¿**: è°ƒæ•´GCå‚æ•°æˆ–ä½¿ç”¨ZGC
3. **CPUå ç”¨é«˜**: è°ƒæ•´ç­‰å¾…ç­–ç•¥æˆ–çº¿ç¨‹äº²å’Œæ€§

### è°ƒè¯•å·¥å…·

- JProfiler: æ€§èƒ½åˆ†æ
- JConsole: JVMç›‘æ§
- perf: ç³»ç»Ÿçº§æ€§èƒ½åˆ†æ

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶

## è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤Issueå’ŒPull Requestï¼

## ç›¸å…³æ–‡æ¡£

- [LMAX Disruptorå®˜æ–¹æ–‡æ¡£](https://lmax-exchange.github.io/disruptor/)
- [Javaå†…å­˜æ¨¡å‹è¯¦è§£](https://docs.oracle.com/javase/specs/jls/se21/html/jls-17.html)
- [JMHç”¨æˆ·æŒ‡å—](https://github.com/openjdk/jmh)

---

**æ³¨æ„**: æœ¬é¡¹ç›®ä»…ç”¨äºæŠ€æœ¯æ¼”ç¤ºå’Œå­¦ä¹ ç›®çš„ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å‰è¯·è¿›è¡Œå……åˆ†çš„æµ‹è¯•å’Œè¯„ä¼°ã€‚